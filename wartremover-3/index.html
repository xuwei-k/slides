<DOCTYPE html>
<html>
  <head>
    <title>Wartremoverã®Scala 3å¯¾å¿œ</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <style type="text/css">
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body {
        font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace;
      }
      ul li ul li {
        font-size: 75%;
      }
      p {
        font-size: 150%;
      }
      li {
        font-size: 30px;
      }
      .remark-slide-content h1 {
        font-size: 70px;
      }
      .remark-slide-content h2 {
        font-size: 50px;
      }
      h1, h2, h3, h4 {
        font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        font-weight: normal;
        text-align: center;
      }
      img {
        max-width : 100%;
        max-height : 70%;
        display: block;
        margin-left: auto;
        margin-right: auto;
        border: 1px gray solid;
      }
      .s {
        font-size: 85%;
      }
      .remark-code, .remark-inline-code {
        font-size: 20px;
        font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace;
      }
      /* Two-column layout */
      .left-column {
        width: 50%;
        float: left;
      }
      .right-column {
        width: 45%;
        float: right;
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Wartremoverã®<br/>Scala 3å¯¾å¿œ

[ScalaMatsuri 2022](https://scalamatsuri.org)


---
class: middle

<img src="image/xuwei.gif" alt="icon" style="zoom: 0.3" />

- twitter [@xuwei_k](https://twitter.com/xuwei_k)
- github [@xuwei-k](https://github.com/xuwei-k)
- blog <https://xuwei-k.hatenablog.com>

---
class: middle, center

è¿‘æ³

## [Scala 3ç§»è¡Œã®ç™ºè¡¨](https://xuwei-k.hatenablog.com/entry/2022/03/05/100217)

---
class: middle

## What is Wartremover?

- Compiler Plugin
- Linter
- ç‹¬è‡ªã®ruleã‚’æ›¸ã„ã¦æ‹¡å¼µå¯èƒ½

---
class: middle

## Wartremover History

- 2013
  - [initial commit](https://github.com/wartremover/wartremover/commit/a0bf88cbec9726800fc) by [@puffnfresh](https://github.com/puffnfresh)
- 2016 to 2018 ?
  - second maintainer [@ClaireNeveu](https://github.com/ClaireNeveu)
- 2019 ~
  - [@xuwei-k](https://github.com/xuwei-k)

---
class: middle

### [Wartremover Contributors](https://github.com/wartremover/wartremover/graphs/contributors)

<img src="image/contributors.png" alt="contributors" />

---
class: middle, center

å¤§å‰æ

## compiler pluginã¯ä½•ã‚ˆã‚Šã‚‚<br/>å¼·åŠ›ãªä»£ã‚ã‚Šã«è«¸åˆƒã®å‰£ãªã®ã§<br/>æœ¬å½“ã«å¿…è¦ãªæ™‚ä»¥å¤–<br/>ä½œã‚‹ã¹ãã§ã¯ãªã„ï¼

---
class: middle

## Compiler PluginãŒå¼·åŠ›?

- macroã‚ˆã‚Šå¼·åŠ›
- å¾®å¦™ãªã¨ã“ã‚ã§ã¯ã‚ã‚‹ãŒã€ç”¨é€”ã«ã‚ˆã£ã¦ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã§æ¸ˆã‚€ãªã‚‰ãã®æ–¹ãŒãƒã‚·ãªå ´åˆã‚‚

---
class: middle

## Wartremover<br/><br/>or<br/><br/>Scalafix?

---
class: middle

## Scalafix

- æ–°ã—ã„
- æ›¸ãæ›ãˆã¾ã§å‡ºæ¥ã¦é«˜æ©Ÿèƒ½ã€ä¾¿åˆ©
- ASTãŒç¶ºéº—ï¼Ÿ(è¦å‡ºå…¸
- ã‚ã‚‹æ„å‘³ã€æ—¢ã«Scala 3å¯¾å¿œæ¸ˆ
  - scalafixãã®ã‚‚ã®ã¯Scala 2ã§æ›¸ã‹ã‚Œã¦ã‚‹ãŒã€<br>Scala 3 codeã«å¯¾ã—é©ç”¨å¯

---
class: middle, center

## [Scalafixå…¬å¼ã«wartremoverå«ã‚ãŸé–¢é€£ãƒ„ãƒ¼ãƒ«ã¨ã®æ¯”è¼ƒãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ã‚ˆ](https://scalacenter.github.io/scalafix/docs/users/related-projects.html)

---
class: middle

ãªãœScalafixãŒã‚ã‚‹ã®ã«Wartremoverã‚’é ‘å¼µã‚‹ã®ã‹ï¼Ÿ

## Scalafixã®SemanticRule<br/>ãŒé‡ãŸã„ï¼ï¼ï¼

---
class: middle

## Scalafixã¯2ç¨®é¡

- SyntacticRule
  -  å‹æƒ…å ±æ‰±ãˆãªã„ã€‚ã‚ãã¾ã§parseã—ãŸçµæœã®ã¿
- SemanticRule
  - Syntacticã¨æ¯”è¼ƒã—ãŸã‚‰è¿½åŠ ã§å‹æƒ…å ±ã®ã‚ˆã†ãªã‚‚ã®ãŒæ‰±ãˆã‚‹?
  - å®Œå…¨ãªå‹ã§ã¯ãªã„ã‚‰ã—ã„?(ã‚ˆãã‚ã‹ã£ã¦ãªã„)
  - é‡ã„ã€å®Ÿè¡Œã«æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§ã€å€‹äººçš„ã«ã‚ã¾ã‚Šæ›¸ã„ã¦ãªã„

---
class: middle

## SemanticRule

å‹æƒ…å ±æ‰±ã†ãŸã‚ã«semanticdbã¨ã„ã†ã‚‚ã®ã‚’compileæ™‚ã«å‡ºã™ãŒã€ãã‚ŒãŒé…ã„ï¼Ÿé‡ãŸã„ï¼Ÿ

---
class: middle, center

compiler pluginã®æ–¹ãŒåŸç†ä¸Šã‹ã‚‹ããªã‚‹ã¯ãšï¼Ÿ

â†“

ã§ã¯wartremoverã®Scala 3å¯¾å¿œ<br/>ã‚‚é ‘å¼µã£ã¦ã¿ã‚‹ã‹ï¼Ÿ

---
class: middle, center

## Wartremover Scala 3<br>å¯¾å¿œã®éšœå£

Compilerä¾å­˜ãªã®ã§å…¨éƒ¨æ›¸ãç›´ã—ï¼Ÿï¼Ÿï¼Ÿ

test codeã‚‚ï¼Ÿï¼Ÿï¼Ÿ

---
class: middle, center

## test codeã ã‘ã§ã‚‚Scala 2<br/>ã¨å…±é€šåŒ–ã™ã‚‹ä»•çµ„ã¿ä½œã‚ŠãŸã„ï¼

---
class: middle, center

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">Scala 3ã®compiler pluginã€åŒã˜sbt projectå†…éƒ¨ã§é–‹ç™ºã¨å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¦ã‚‚ã€å˜ç´”ã«ã‚„ã‚‹ã¨ClassLoaderãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ã—ã¾ã£ã¦ã€pluginã®ã‚½ãƒ¼ã‚¹ã„ã˜ã£ã¦ã‚‚åæ˜ ã•ã‚Œãªãã¦ã€sbtä¸¸ã”ã¨ç«‹ã¡ä¸Šã’ç›´ã•ãªã„ã¨ã„ã‘ãªã„ãƒ»ãƒ»ãƒ»ï¼Ÿ<a href="https://t.co/5Md7rnUReX">https://t.co/5Md7rnUReX</a></p>&mdash; Kenji Yoshida (@xuwei_k) <a href="https://twitter.com/xuwei_k/status/1486975966073483265?ref_src=twsrc%5Etfw">January 28, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

---
class: middle

## ãã‚‚ãã‚‚compiler plugin<br/>ã®testã©ã†æ›¸ãï¼Ÿ

---
class: middle

## compiler pluginã®test

- sbtã®scripted test?
- "compileæ™‚ã«è­¦å‘ŠãŒå‡ºã‚‹" ã“ã¨ã®testã¨ã¯ï¼Ÿ

---
class: middle

### [Wartremover 2ã«ãŠã‘ã‚‹test](https://github.com/wartremover/wartremover/blob/d3be1992dabab95a4c6e9fe5ce897b0f02feb89d/core/src/test/scala/org/wartremover/test/SizeIsTest.scala)

```scala
val result = WartTestTraverser(SizeIs) {
  List(3).size == 1
  Vector(3).size <= 1
  Iterable(3).size >= 1
  Map.empty[Int, String].size > 1
  Set.empty[Boolean].size < 1
}
assertErrors(result)(
  "Maybe you can use `sizeIs` instead of `size`",
  5
)
```

<span style="font-size: 70%">collectionã®sizeã ã£ãŸã‚‰sizeIsã«ç½®ãæ›ãˆå¯èƒ½<br/>ãªã“ã¨ã‚’æ•™ãˆã¦ãã‚Œã‚‹ãƒ«ãƒ¼ãƒ«ã®test</span>

---
class: middle

```scala
val result = WartTestTraverser(SizeIs) {
  Array(2).size == 1
  Array(true).length <= 3
  "foo".size == 2
  "foo".length == 3
  (null: java.util.List[String]).size > 4
}
assertEmpty(result)
```

<span style="font-size: 70%">Arrayã‚„Stringã¯è­¦å‘Šå‡ºã•ãªã„ã‹ï¼Ÿ</span>

---
class: middle, center

### Wartremover 2ã«ãŠã‘ã‚‹test

## [å˜ç´”ãªcompiler plugin<br/>ã¨ã¯åˆ¥ã®å°‚ç”¨macroãŒã‚ã‚‹ï¼](https://github.com/wartremover/wartremover/blob/d3be1992dabab95a4c6e9fe5ce897b0f02feb89d/core/src/main/scala-2/org/wartremover/test/WartTestTraverser.scala)

---
class: middle

<embed src="graph.svg" type="image/svg+xml" />

---
class: middle

#### Wartremover 2ã«ãŠã‘ã‚‹test

- compiler pluginã¨ã¯åˆ¥ã®macroï¼Ÿï¼Ÿï¼Ÿ
- ã‚‚ã¡ã‚ã‚“æ™®é€šã®macroã§ã¯ãªãcompilerã®APIã‚‚è§¦ã‚‹è‹¥å¹²ã®é»’é­”è¡“ãªmacro

---
class: middle

Wartremover 2ã«ãŠã‘ã‚‹testç”¨macro

- macro input
  - source code
- [macro output](https://github.com/wartremover/wartremover/blob/d3be1992dabab95a4c6e9fe5ce897b0f02feb89d/core/src/main/scala-2/org/wartremover/test/WartTestTraverser.scala#L10)
  - <span style="font-size:130%">warnings: List[String]</span>
  - <span style="font-size:130%">errors: List[String]</span>

---
class: middle, center

Scala 3ã«ãŠã‘ã‚‹testç”¨macroã®ä½œã‚Šæ–¹è¬›åº§ãƒ»ãƒ»ãƒ»?

ã®å‰ã«Scala 2ã®wartremoverã®<br>ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨é–¢é€£ç”¨èªè§£èª¬

---
class: middle

#### Scala 2 wartremoveré–¢é€£ç”¨èªé›†

- [WartUniverse](https://github.com/wartremover/wartremover/blob/d3be1992dabab95a4c6e9fe5ce897b0f02feb89d/core/src/main/scala-2/org/wartremover/WartTraverser.scala#L151)
  - Scala 2ã®Universeã®wapperã‹ã¤ãã®ä»–errorã¨warningãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©ãªã©
- [WartTraverser](https://github.com/wartremover/wartremover/blob/d3be1992dabab95a4c6e9fe5ce897b0f02feb89d/core/src/main/scala-2/org/wartremover/WartTraverser.scala#L8)
  - å€‹ã€…ã®ruleã‚’å®šç¾©ã™ã‚‹æ™‚ã«ç¶™æ‰¿ã™ã‚‹trait
  - WartUniverseã‚’å—ã‘å–ã£ã¦ã€Traverserã‚’è¿”ã™
- [Traverser](https://github.com/scala/scala/blob/v2.13.8/src/reflect/scala/reflect/api/Trees.scala#L2487)
  - scala-reflect 2å†…éƒ¨ã®class
- [Global](https://github.com/scala/scala/blob/v2.13.8/src/compiler/scala/tools/nsc/Global.scala#L45)
  - compileæ™‚ã«å¿…è¦ãªæƒ…å ±ã‚’å…¨ã¦æŒã£ã¦ã„ã¦å¼•å›ã™Scala 2 compilerå†…éƒ¨ã®class

---
class: middle, center

## Universe?å®‡å®™?ğŸ¤”

<img src="https://c.pxhere.com/photos/ce/ba/moon_planet_space_astronomy_galaxy_sky_universe_night-1194715.jpg!d" srcset="https://c.pxhere.com/photos/ce/ba/moon_planet_space_astronomy_galaxy_sky_universe_night-1194715.jpg!d">

---
class: middle

[Scala 2 wartremoverå®šç¾©ä¾‹](https://github.com/wartremover/wartremover/blob/d3be1992dabab95a4c6e9fe5ce897b0f02feb89d/core/src/main/scala-2/org/wartremover/warts/SizeIs.scala)

```scala
object SizeIs extends WartTraverser {
  override def apply(u: WartUniverse): u.Traverser = {
    import u.universe._
    new Traverser {
      override def traverse(tree: Tree): Unit = {
        tree match {
          case t if hasWartAnnotation(u)(t) =>
          case Apply(
                Select(
                  Select(
                    IsScalaCollection(),
                    a @ (TermName("size") | TermName("length"))
                  ),
                  Method()
                ),
                List(_)
              ) if !isSynthetic(u)(tree) =>
            error(u)(
              tree.pos,
              s"Maybe you can use `${a.decodedName}Is` instead of `${a.decodedName}`"
            )
```

---
class: middle

#### Scala 3 wartremoverç”¨èªé›†

- WartUniverseã¨WartTraverser
  - åŒã˜ã‚ˆã†ãªã‚‚ã®ä½œã‚‹äºˆå®šï¼Ÿ
- Traverser
  - [scala3-libraryã®ã‚‚ã®](https://github.com/lampepfl/dotty/blob/55877679f120b39740fbb87d345c0b1356f07a5d/library/src/scala/quoted/Quotes.scala#L4482)ã‚’ä½¿ã†ï¼Ÿ(å¾Œè¿°)
- Scala 2 compilerã®Global
  - Scala 3ã§ã¯[Context](https://github.com/lampepfl/dotty/blob/55877679f120b39740fbb87d345c0b1356f07a5d/compiler/src/dotty/tools/dotc/core/Contexts.scala#L126)ã¨ã„ã†ã‚‚ã®ã«ãªã£ã¦ã‚‹
- Quotes
  - [Scala 3ã§macroæ›¸ãæ™‚ã«å¿…ãšæ¸¡ã£ã¦ãã‚‹ã€å¿…è¦ã«ãªã‚‹ä½•ã‹](https://github.com/lampepfl/dotty/blob/55877679f120b39740fbb87d345c0b1356f07a5d/library/src/scala/quoted/Quotes.scala)

---
class: middle

### Scala 3ã«ãŠã‘ã‚‹testç”¨macroã®ä½œã‚Šæ–¹è¬›åº§

- 1: Scala 2ã¨åŒã˜ã‚ˆã†ãªã‚·ã‚°ãƒãƒãƒ£ã®macroã‚’å®šç¾©
- 2: æ¸¡ã£ã¦ããŸQuotesã‚’[`scala.quoted.runtime.impl.QuotesImpl`](https://github.com/lampepfl/dotty/blob/55877679f120b39740fbb87d345c0b1356f07a5d/compiler/src/scala/quoted/runtime/impl/QuotesImpl.scala)ã«ç„¡ç†çŸ¢ç†asInstanceOf
- 3: QuotesImplã¯Contextã‚’å†…åŒ…ã—ã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚’å–ã‚Šå‡ºã—ã¦ç‹¬è‡ª[Reporter](https://github.com/lampepfl/dotty/blob/55877679f120b39740fbb87d345c0b1356f07a5d/compiler/src/dotty/tools/dotc/reporting/Reporter.scala#L64)ã‚’set

---
class: middle

### Scala 3ã«ãŠã‘ã‚‹testç”¨macroã®ä½œã‚Šæ–¹è¬›åº§

- 4: ç´°ã‹ã„å‡¦ç†ä¸­ç•¥
- 5: æ¤œæŸ»å¯¾è±¡ã®Exprã‚’å¼•æ•°ã§å—ã‘å–ã£ãŸTraverserã§traverse
- 6: è¨­å®šã—ãŸç‹¬è‡ªReporterã‹ã‚‰warningsã¨errorså–ã‚Šå‡ºã—ã¦macroã®æˆ»ã‚Šå€¤ã¨ã—ã¦è¿”ã™

---
class: middle

Scala 3ã«ãŠã‘ã‚‹testç”¨macro

```scala
inline def apply[A <: WartTraverser](inline t: A)(inline a: Any): Result = ${ applyImpl[A]('t, 'a) }

def applyImpl[A <: WartTraverser: Type](
  t: Expr[A], expr: Expr[Any]
)(using q1: Quotes): Expr[Result] = {
  val q2 = q1.asInstanceOf[QuotesImpl]
  val reporter = new WartReporter
  q2.ctx.asInstanceOf[FreshContext].setReporter(reporter)
  val wart = {
    val clazz = Class.forName(t.show + NameTransformer.MODULE_SUFFIX_STRING)
    clazz.getField(NameTransformer.MODULE_INSTANCE_NAME).get(null).asInstanceOf[WartTraverser]
  }
  val universe = new WartUniverse(q1, wart, false, LogLevel.Info)
  val x: universe.Traverser = wart.apply(universe)
  val term = x.q.reflect.asTerm(expr)
  x.traverseTree(term)(term.symbol)
  val result1 = reporter.result
  val warnings = result1.collect { case a if a.level() == DiagnosticInterface.WARNING => a.message() }
  val errors = result1.collect { case a if a.level() == DiagnosticInterface.ERROR => a.message() }
  Expr(Result(errors = errors, warnings = warnings))
}
```

---
class: middle

## compiler pluginã®è¾›ã•

- scalafixã¨æ¯”è¼ƒã—ã¦TreeãŒç¶ºéº—ã§ã¯ãªã„ï¼Ÿ
  - Scala 3ã®æ–¹ãŒå¤šå°‘ã¾ã—ï¼Ÿã ãŒåœ§å€’çš„ã«scalafixä½¿ã„ã‚„ã™ã„
  - æ…£ã‚Œã®å•é¡Œï¼Ÿå€‹äººã®æ„Ÿæƒ³ï¼Ÿ
- compilerå†…éƒ¨ã«ä¾å­˜ã—ã¦ã—ã¾ã†ã¨compilerãŒäº’æ›å£Šã™ã¨è¾›ã„
  - libraryã¨é•ã„äº’æ›ã¯ã‚ã¾ã‚Šä¿è¨¼ã•ã‚Œãªã„

---
class: middle

## compiler pluginã®è¾›ã•

- typer phaseå¾Œã ã¨è‡ªå‹•ç”Ÿæˆéƒ¨åˆ†ã¾ã§æ¸¡ã£ã¦ãã‚‹
  - case classã®copy
  - PartialFunction(applyOrElseã‚„isDefinedAtã«å±•é–‹)
  - xml literalãŒå±•é–‹å¾Œ(å¾Œè¿°)
  - ãã®ä»–è‰²ã€…ã€‚Scala 2ã‚‚3ã‚‚åŒæ§˜
- typerã®å‰ã®parser phaseå¾Œã§å—ã‘å–ã‚Œã‚‹ã®ã‹è¬
  - ã‚„ã£ã¦ã¿ãŸã‘ã©ã‚ˆãã‚ã‹ã‚‰ãªã„
- macroã‹ã‚‰å±•é–‹ã•ã‚ŒãŸcodeã‹ï¼Ÿãªã©ã‚‚è€ƒæ…®ã™ã‚‹å¿…è¦ã‚ã‚Š


---
class: middle

```scala
val x: PartialFunction[Int, Int] = {
  case x if x % 2 == 0 => x.toString
}
```

```bash
scala -Xprint:typer -e "ã“ã“ã«ã‚³ãƒ¼ãƒ‰"
```

---
class: middle

```scala
val x: PartialFunction[Int,Int] = ({
  @SerialVersionUID(value = 0) final <synthetic> class $anonfun extends scala.runtime.AbstractPartialFunction[Int,Int] with java.io.Serializable {
    def <init>(): <$anon: Int => Int> = {
      $anonfun.super.<init>();
      ()
    };
    final override def applyOrElse[A1 <: Int, B1 >: Int](x1: A1, default: A1 => B1): B1 = ((x1.asInstanceOf[Int]: Int): Int @unchecked) match {
      case (x @ _) if x.%(2).==(0) => x.toString()
      case (defaultCase$ @ _) => default.apply(x1)
    };
    final def isDefinedAt(x1: Int): Boolean = ((x1.asInstanceOf[Int]: Int): Int @unchecked) match {
      case (x @ _) if x.%(2).==(0) => true
      case (defaultCase$ @ _) => false
    }
  };
  new $anonfun()
}: PartialFunction[Int,Int]);
```

---
class: middle

```
$ scala -Xprint:typer -e "case class A(x: Int)"
```

<pre><code class="scala hljs remark-code" style="font-size: 40%;">
case class A extends AnyRef with Product with Serializable {
  <caseaccessor> <paramaccessor> private[this] val x: Int = _;
  <stable> <caseaccessor> <accessor> <paramaccessor> def x: Int = A.this.x;
  def <init>(x: Int): this.A = {
    A.super.<init>();
    ()
  };
  <synthetic> def copy(x: Int = x): this.A = new A(x);
  <synthetic> def copy$default$1: Int = A.this.x;
  override <synthetic> def productPrefix: String = "A";
  <synthetic> def productArity: Int = 1;
  <synthetic> def productElement(x$1: Int): Any = x$1 match {
    case 0 => A.this.x
    case _ => scala.runtime.Statics.ioobe[Any](x$1)
  };
  override <synthetic> def productIterator: Iterator[Any] = scala.runtime.ScalaRunTime.typedProductIterator[Any](A.this);
  <synthetic> def canEqual(x$1: Any): Boolean = x$1.$isInstanceOf[this.A]();
  override <synthetic> def productElementName(x$1: Int): String = x$1 match {
    case 0 => "x"
    case _ => scala.runtime.Statics.ioobe[String](x$1)
  };
  override <synthetic> def hashCode(): Int = {
    <synthetic> var acc: Int = -889275714;
    acc = scala.runtime.Statics.mix(acc, A.this.productPrefix.hashCode());
    acc = scala.runtime.Statics.mix(acc, x);
    scala.runtime.Statics.finalizeHash(acc, 1)
  };
  override <synthetic> def toString(): String = scala.runtime.ScalaRunTime._toString(A.this);
  override <synthetic> def equals(x$1: Any): Boolean = A.this.eq(x$1.asInstanceOf[Object]).||(x$1 match {
     case (_: this.A) => true
     case _ => false
   }.&&({
    <synthetic> val A$1: this.A = x$1.asInstanceOf[this.A];
    A.this.x.==(A$1.x).&&(A$1.canEqual(A.this))
  }))
};

<synthetic> private object A extends scala.runtime.AbstractFunction1[Int,this.A] with java.io.Serializable {
  def <init>(): this.A.type = {
    A.super.<init>();
    ()
  };
  final override <synthetic> def toString(): String = "A";
  case <synthetic> def apply(x: Int): this.A = new A(x);
  case <synthetic> def unapply(x$0: this.A): Option[Int] = if (x$0.eq(null))
    scala.None
  else
    Some.apply[Int](x$0.x)
}
</code></pre>

---
class: middle

### Scala 3.1.1 [compiler phases](https://github.com/lampepfl/dotty/blob/3.1.1/compiler/src/dotty/tools/dotc/Compiler.scala#L19-L144)

<pre><code class="bash hljs remark-code" style="font-size: 50%;">
$ scala -Xshow-phases
parser
typer
inlinedPositions
sbt-deps
extractSemanticDB
posttyper
prepjsinterop
sbt-api
SetRootTree
pickler
inlining
postInlining
staging
pickleQuotes
{firstTransform, checkReentrant, elimPackagePrefixes, cookComments, checkStatic, checkLoopingImplicits, betaReduce, inlineVals, expandSAMs}
initChecker
{elimRepeated, protectedAccessors, extmethods, uncacheGivenAliases, byNameClosures, hoistSuperArgs, specializeApplyMethods, refchecks, tryCatchPatterns, patternMatcher}
{elimOpaque, explicitJSClasses, explicitOuter, explicitSelf, elimByName, stringInterpolatorOpt}
{pruneErasedDefs, uninitializedDefs, inlinePatterns, vcInlineMethods, seqLiterals, intercepted, getters, specializeFunctions, liftTry, collectNullableFields, elimOuterSelect, resolveSuper, functionXXLForwarders, paramForwarding, genericTuples, letOverApply, arrayConstructors}
erasure
{elimErasedValueType, pureStats, vcElideAllocations, arrayApply, addLocalJSFakeNews, elimPolyFunction, tailrec, completeJavaEnums, mixin, lazyVals, memoize, nonLocalReturns, capturedVars}
{constructors, instrumentation}
{lambdaLift, elimStaticThis, countOuterAccesses}
{dropOuterAccessors, checkNoSuperThis, flatten, transformWildcards, moveStatic, expandPrivate, restoreScopes, selectStatic, junitBootstrappers, Collect entry points, collectSuperCalls, repeatableAnnotations}
genSJSIR
genBCode
</code></pre>

---
class: middle

### Scala 2.13.8 [compiler phases](https://github.com/scala/scala/blob/v2.13.8/src/compiler/scala/tools/nsc/Global.scala#L679-L701)

<pre><code class="bash hljs remark-code" style="font-size: 50%;">
$ scala -Xshow-phases
    phase name  id  description
    ----------  --  -----------
        parser   1  parse source into ASTs, perform simple desugaring
         namer   2  resolve names, attach symbols to named trees
packageobjects   3  load package objects
         typer   4  the meat and potatoes: type the trees
superaccessors   5  add super accessors in traits and nested classes
    extmethods   6  add extension methods for inline classes
       pickler   7  serialize symbol tables
     refchecks   8  reference/override checking, translate nested objects
        patmat   9  translate match expressions
       uncurry  10  uncurry, translate function values to anonymous classes
        fields  11  synthesize accessors and fields, add bitmaps for lazy vals
     tailcalls  12  replace tail calls by jumps
    specialize  13  @specialized-driven class and method specialization
 explicitouter  14  this refs to outer pointers
       erasure  15  erase types, add interfaces for traits
   posterasure  16  clean up erased inline classes
    lambdalift  17  move nested functions to top level
  constructors  18  move field definitions into constructors
       flatten  19  eliminate inner classes
         mixin  20  mixin composition
       cleanup  21  platform-specific cleanups, generate reflective calls
    delambdafy  22  remove lambdas
           jvm  23  generate JVM bytecode
      terminal  24  the last phase during a compilation run
</code></pre>

---
class: middle

### What is Typer?

ä»¥ä¸‹ã¯Scala 2ã¨3ã§ãŠãã‚‰ãå¤§ä½“åŒã˜?

- å‹ä»˜ã‘å«ã‚è‰²ã€…ã‚„ã‚‹ã‚‰ã—ã„
  - è©³ç´°çŸ¥ã‚‰ãªã„
- implicitæ¢ç´¢ãªã©ã‚‚ãŠãã‚‰ãã“ã“ã ã—ã€å¤§æŠµã“ã“ãŒé…ã„?
- å¤§æŠµã®compiler pluginæ›¸ãå ´åˆã¯ã“ã®å¾Œï¼Ÿ

---
class: middle

## compiler pluginã®è¾›ã•

- ä»–ã®compiler plugin(ä¾‹: scoverage)ã¨çµ„ã¿åˆã‚ã›ã‚‹ã¨ã‚ã‚Šå¾—ãªã„Treeæ¸¡ã£ã¦ãã‚‹ã®ã§ç‰¹æ®Šå‡¦ç†å¿…è¦
- compilerå†…éƒ¨ã¯mutable(Scala 2ã‚‚3ã‚‚)
- errorãŒå‡ºãŸå ´åˆã®åŸå› ãŒæ…£ã‚Œãªã„ã¨ã‚ã‹ã‚Šã«ãã„ï¼Ÿ

---
class: middle

```bash
$ scala -version 
Scala code runner version 2.12.15 -- Copyright 2002-2021, LAMP/EPFL and Lightbend, Inc.
$ scala -Xprint:typer -e "<a />"
```

```scala
new scala.xml.Elem(
  null,
  "a",
  scala.xml.Null,
  scala.xml.TopScope,
  true
)
```

---
class: middle

- scala-xmlã®å¯¾ç­–ã—ãªã„ã¨!
- å®‰æ˜“ã«scala-xmlã®classç›´æ¥è§¦ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã
- scala-xmlã¯æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¯ãªã„ã®ã§ã€scala-xmlã®ä¾å­˜ãŒãªã„ã¨compilerãŒæ­»ã¬ã‚³ãƒ¼ãƒ‰ã«ãªã£ã¦ã—ã¾ã†ï¼

---
class: middle

## compiler pluginã®è‰¯ã„ã¨ã“ã‚

- compilerå†…éƒ¨ã®å®Œå…¨ãªå‹ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- compileé€”ä¸­ã®phaseã«æŒŸã¿è¾¼ã‚ã°åŸç†ä¸Šä¸€ç•ªç„¡é§„ãŒãªã„
  - ä¸­é–“ãƒ‡ãƒ¼ã‚¿çš„ãªã‚‚ã®ãŒä¸€ç•ªå°‘ãªãã¦æ¸ˆã‚€ã¯ãšï¼Ÿ
- Scala 3ã ã¨Exprã‚’ç›´æ¥pattern matchå‡ºæ¥ã¦ä¾¿åˆ©ï¼
  - ãŸã ã—å‰²ã¨ã¾ã bugã‚‚ã‚ã‚‹

---
class: middle

Exprã®matchæ¥½ã—ã„ï¼ä¾¿åˆ©ï¼æœ€é«˜ï¼


```scala
t.asExpr match {
  case '{ ($x1: Iterable[t]).size < ($x2: Int) } =>
    error(u)(tree.pos, sizeMessage)
  case '{ ($x1: Iterable[t]).size == ($x2: Int) } =>
    error(u)(tree.pos, sizeMessage)
  case '{ ($x1: Iterable[t]).size <= ($x2: Int) } =>
    error(u)(tree.pos, sizeMessage)
```

ãŸã ã—ã€ã‚ãã¾ã§Exprã ã‘ã§ã‚ã£ã¦ã€<br/>å…¨ã¦ãŒã“ã‚Œã§æ›¸ã‘ã‚‹ã‚ã‘ã§ã¯ãªã„

---
class: middle

```scala
t.asExpr match {
  case '{ ($x: List[t]).toList } =>
    error(u)(tree.pos, "redundant toList conversion")
  case '{ ($x: Vector[t]).toVector } =>
    error(u)(tree.pos, "redundant toVector conversion")
  case '{ ($x: Set[t]).toSet } => // ã“ã“ã§ãªãœã‹æ­»ã¬ï¼Ÿï¼Ÿï¼Ÿ
    error(u)(tree.pos, "redundant toSet conversion")
```

---
class: middle

å ±å‘Šã—ãŸbugãã®1

<https://github.com/lampepfl/dotty/issues/14708>

---
class: middle

æ­£è§£ã¯ã“ã¡ã‚‰

[Exprã®pattern matchå†…éƒ¨ã§å‹è‡ªä½“ã‚’å¤‰æ•°ã¨ã—ã¦æ‰±ã†å ´åˆã®æ›¸ãæ–¹](https://github.com/scala/docs.scala-lang/blob/4a79b3f6233060eba7b151e596c3ec601bfcb1d4/_overviews/scala3-macros/tutorial/quotes.md?plain=1#L322-L343)

```scala
case '{
      type t1
      type t2 >: `t1`
      ($x: Set[`t1`]).toSet[`t2`]
    } =>
  error(u)(tree.pos, "redundant toSet conversion")
```

---
class: middle

ä¸¡æ–¹ã®å¤‰æ•°ã‚’å‚ç…§å‡ºæ¥ã‚‹ã‘ã©ä½•ã“ã‚Œï¼Ÿ ğŸ¤”

```scala
import scala.quoted.*

object Macros {
  def fooImpl(a: Expr[Any])(using Quotes): Expr[Any] = a match {
    case '{ $x1: String } | '{ $x2: Int } =>
      println((x1, x2))
      a
  }

  inline def foo(a: Any) = ${fooImpl('a)}
}
```

---
class: middle

å ±å‘Šã—ãŸbugãã®2

<https://github.com/lampepfl/dotty/issues/14696>

```java
java.lang.VerifyError: Bad local variable type
Exception Details:
  Location:
    example/Macros$.fooImpl(Lscala/quoted/Expr;Lscala/quoted/Quotes;)Lscala/quoted/Expr; @179: aload
  Reason:
    Type top (current frame, locals[8]) is not assignable to reference type
  Current Frame:
    bci: @179
    flags: { }
    locals: { 'example/Macros$', 'scala/quoted/Expr', 'scala/quoted/Quotes', 'scala/quoted/Expr', 'scala/Option' }
    stack: { 'scala/Predef$', 'scala/Tuple2$' }
```

---
class: middle

### Wartremoverã®compiler pluginå´å®Ÿè£…äºˆå®šã‚³ãƒ¼ãƒ‰

<pre><code class="scala hljs remark-code" style="font-size: 80%;">
import dotty.tools.dotc.plugins.PluginPhase
import dotty.tools.dotc.plugins.StandardPlugin

class WartremoverPlugin extends StandardPlugin {
  override def name = "wartremover"

  override def description = "wartremover"

  override def init(options: List[String]): List[PluginPhase] = {
    // ã“ã“ã§å¼•æ•°parseã™ã‚‹

    val newPhase = new WartremoverPhase(
      // parseã—ãŸå¼•æ•°ã‹ã‚‰ç”Ÿæˆã—ãŸã‚‚ã®æ¸¡ã™
    )
    newPhase :: Nil
  }
</code></pre>

---
class: middle

### Wartremoverã®compilerã®phaseå®Ÿè£…äºˆå®šã‚³ãƒ¼ãƒ‰

<pre><code class="scala hljs remark-code" style="font-size: 50%;">
class WartremoverPhase(
  errorWarts: List[WartTraverser], warningWarts: List[WartTraverser]
  // ãã®ä»–ã®å¼•æ•°çœç•¥
) extends PluginPhase {
  override def phaseName = "wartremover"
  // Typerã®å¾Œã«å®Ÿè¡Œã—ã¦ï¼ã¨ã„ã†æŒ‡å®š
  override val runsAfter = Set(TyperPhase.name)

  // ä»–ã«ã‚‚è‰²ã€…ã‚ã‚‹ãŒã€ãŠãã‚‰ãã“ã‚Œã ã‘ã§åŸç†ä¸Šå…¨éƒ¨ã®Treeè¾¿ã‚Œã‚‹ï¼Ÿ
  override def prepareForUnit(tree: Tree)(using c: Context) = {
    // Contextã¨æ–°ã—ã„Quotesã‚’ç”Ÿæˆ
    val c2 = QuotesCache.init(c.fresh)
    val q = scala.quoted.runtime.impl.QuotesImpl()(using c2)
    def runWart(w: WartTraverser, onlyWarning: Boolean): Unit = {
      val universe = new WartUniverse(
        quotes = q,
        traverser = w,
        onlyWarning = onlyWarning,
        // ãã®ä»–å¼•æ•°
      )
      val traverser = w.apply(universe)
      // compilerå†…éƒ¨ã®Treeã‚’libraryå´ã®Treeã«ç„¡ç†çŸ¢ç†ã‚­ãƒ£ã‚¹ãƒˆï¼
      val t = tree.asInstanceOf[traverser.q.reflect.Tree]
      try {
        traverser.traverseTree(t)(t.symbol)
      } catch {
        case NonFatal(e) =>
          // å ´åˆã«ã‚ˆã£ã¦ãƒ­ã‚°å‡ºã™
      }
    }
    errorWarts.foreach(w => runWart(w = w, onlyWarning = false))
    warningWarts.foreach(w => runWart(w = w, onlyWarning = true))
    c
  }
</code></pre>

---
class: middle

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ‚©ã¿

å€‹ã€…ã®wart?rule?ã‚’æ›¸ãå´ã«ã¯scala3-libraryå´ã®APIä½¿ã‚ã›ã‚‹

or

compilerã®ASTãã®ã¾ã¾è§¦ã£ã¦ã‚‚ã‚‰ã†ï¼Ÿ

---
class: middle

## [scala-reflect 2ã®ASTãŒæŠ½è±¡åŒ–ã•ã‚Œã¦ãªã„ä¾‹](https://github.com/scala/scala/blob/c16096df2ab9c666f802762277950ed8734141eb/src/reflect/scala/reflect/api/Trees.scala#L680)

A labelled expression.  Not expressible in language syntax, but
generated by the compiler to simulate while/do-while loops, and
also by the pattern matcher.

---
class: middle

## [scala-reflect 2ã®ASTãŒæŠ½è±¡åŒ–ã•ã‚Œã¦ãªã„ä¾‹](https://github.com/scala/scala/blob/c16096df2ab9c666f802762277950ed8734141eb/src/reflect/scala/reflect/api/Trees.scala#L696)

```scala
type LabelDef >: Null <: LabelDefApi
  with DefTree with TermTree
```

- Scala 3ã®Quotes APIã«ã¯å‡ºã¦ã“ãªã„ï¼Ÿ
- éš ã•ã‚Œã¦ã‚‹ã®ã‹ã€æ ¹æœ¬çš„ã«ãªããªã£ãŸã®ã‹ã‚ˆãã‚ã‹ã£ã¦ãªã„

---
class: middle

### scala3-libraryå´ã®APIä½¿ã‚ã›ã‚‹æ¡ˆ

- ç¾çŠ¶ã¯ã€ã“ã®æ–¹é‡ã®äºˆå®š
- compiler pluginã§å—ã‘å–ã£ãŸASTã‚’ç„¡ç†çŸ¢ç†ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹ã¨ã€ã»ã¼å‹•ã
- [ã„ãã¤ã‹ã®Treeã®ç¨®é¡ã§ã“ã“ã§MatchError](https://github.com/lampepfl/dotty/blob/55877679f120b39740fbb87d345c0b1356f07a5d/library/src/scala/quoted/Quotes.scala#L4384-L4467)

---
class: middle

## [Scala 3å¯¾å¿œã®é€²æ—](https://github.com/xuwei-k/wartremover/commit/d7e3b2c795cb0ed252cfc981d8107ddd2a46ad0c)

<img src="image/scala-3-commit.png" />

---
class: middle

### [Scala 3å¯¾å¿œã®é€²æ—](https://github.com/xuwei-k/wartremover/commit/d7e3b2c795cb0ed252cfc981d8107ddd2a46ad0c)

- 6ã€œ7å‰²ã®ãƒ†ã‚¹ãƒˆãŒãã®ã¾ã¾é€šã£ãŸï¼Ÿ
- æ®‹ã‚ŠãŒè‰²ã€…è¾›ã„
- ãã‚‚ãã‚‚Scala 3ã§åŸç†çš„ã«è§£æ±ºã•ã‚Œã¦ã‚‹ã‚‚ã®
  - Productã‚„Serializableã«æ¨è«–ã•ã‚Œãªããªã£ãŸ
  - implicitã«å‹æ›¸ãã®ãŒå¿…é ˆåŒ–
  - implicit conversionç¦æ­¢
  - å¿…ãšfalseã«ãªã‚‹æ¯”è¼ƒãŒcompile error
- è¿‘æ—¥ä¸­ã«3.0.0-RC1å‡ºã™ãƒ»ãƒ»ãƒ»ï¼Ÿ

---
class: middle

### Scala 3ã«ãŠã‘ã‚‹wartremover

- ãã‚‚ãã‚‚scalafixã®SyntacticRuleä½¿ãˆã°å¿…è¦ãªã„ã‚‚ã®è‰²ã€…
- æ˜ã‚‰ã‹ã«å‹æƒ…å ±å¿…è¦ãªãparseã ã‘ã™ã‚Œã°ã™ãã‚ã‹ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
  - throw, null, return, while, var, asInstanceOf, isInstanceOfã®ç¦æ­¢

---
class: middle

(å°‘ã—é ‘å¼µã‚Œã°)ã“ã†ã„ã†ã®ã‚‚scalafixã®SyntacticRuleã§?

- default argumentsç¦æ­¢
- implicit conversionç¦æ­¢
- type classã§ã¯ãªã„(å‹å¼•æ•°æŒãŸãªã„)contextå¼•å›ã—ç”¨implicit paramç¦æ­¢
- sealedç¶™æ‰¿ã—ãŸã‚‰å¿…ãšfinalã«ã—ãªã„ã¨ãƒ€ãƒ¡ã ãï¼

---
class: middle

### Scala 3ã«ãŠã‘ã‚‹wartremover

ã—ã‹ã‚‚scalafixã®æ–¹ãŒcompilerãŒç”Ÿæˆã™ã‚‹codeã«æ‚©ã¾ã•ã‚Œãªã„ï¼

---
class: middle

### version updateã¨å…±ã«ã¤ã„ã§ã«è‰²ã€…æ•´ç†ã—ãŸã„

- deprecatedãªã‚‚ã®å‰Šé™¤
- å¤ã„Scala versionå‰Šé™¤
- Scala 2ã®æ–¹ã‚‚ç´°ã‹ã„APIã®ä½¿ã„å‹æ‰‹æ•´ç†?

---
class: middle

## ç¾çŠ¶ã®wartremoverã¨ã¯é•ã†<br/>ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®Linteræ¡ˆ

---
class: middle

## TATSyã‚’parseã™ã‚‹æ¡ˆ

- TASTyã¨ã¯Scala 3ãŒcompileæ™‚ã«åãå‡ºã™ã€å‹å«ã‚ãŸå…¨ã¦ã®æƒ…å ±ãŒå…¥ã£ãŸã‚‚ã®
  - Scala 2ã¨ã¯ä¿å­˜æ–¹æ³•ã‚‚åˆ¥ã€å…¥ã£ã¦ã‚‹æƒ…å ±é‡ã‚„ç¨®é¡ã‚‚åˆ¥
  - Scala 2ã®å ´åˆã¯ScalaSignatureã¨ã„ã†ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ä»˜åŠ æƒ…å ±å…¥ã£ã¦ã„ãŸ
  - Scala 2ã®æ–¹ãŒæƒ…å ±ãŒå°‘ãªã„ã€‚ã‚ãã¾ã§ã‚·ã‚°ãƒãƒãƒ£ã®ã¿

---
class: middle

## TATSyã‚’parseã™ã‚‹æ¡ˆ

- compileæ™‚ã«ã¯ä¸€åˆ‡å‡¦ç½®è¿½åŠ ã—ãªãã¦è‰¯ã„
  - ä¸€åˆ‡compileãŒé…ããªã‚‰ãªã„
  - compileã¨ã¯åˆ¥ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œå¯èƒ½ãªãƒ¡ãƒªãƒƒãƒˆ
  - scalafixã¯semanticdbå‡ºã™ä»¥å¤–ã§ã¯ã‚ã‚‹æ„å‘³ãã†

---
class: middle

## TATSyã‚’parseã™ã‚‹æ¡ˆ

- åŸç†ä¸Šcompilerã®äº’æ›ã¨TASTyã®äº’æ›ã¯æ„å‘³ãŒé•ã†ãŸã‚ã€TASTyã®äº’æ›ã ã‘æ°—ã«ã™ã‚Œã°è‰¯ã„
- ãŸã ã—ã€compilerã¨ç‹¬ç«‹ã—ãŸTATSyèª­ã¿è¾¼ã¿ãƒ„ãƒ¼ãƒ«ãŒã¾ã æˆç†Ÿã—ã¦ãªã„ï¼Ÿ

---
class: middle, center

## [TASTy Query](https://github.com/scalacenter/tasty-query)

---
class: middle, center

## [TASTy Inspection](https://dotty.epfl.ch/docs/reference/metaprogramming/tasty-inspect.html)

[ã¾ã MatchErrorå‡ºãŸã‚Šã—ã¦è¾›ã„](https://github.com/lampepfl/dotty/issues/14027)

---
class: middle, center

ãŠã‚ã‚Š

    </textarea>
    <script src="https://remarkjs.com/downloads/remark-0.15.0.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript">
      const slideshow = remark.create({
        highlightStyle: "railscasts"
      });
      slideshow.on('beforeShowSlide', function (slide) {
        $("a[href^='http://']").attr("target", "_blank");
        $("a[href^='https://']").attr("target", "_blank");
      });
    </script>
  </body>
</html>
