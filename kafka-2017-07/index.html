<DOCTYPE html>
<html>
  <head>
    <title>kafkaã§publishã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç‹¬è‡ªã«ä½œã£ã¦ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¹ã‚’ç„¡ãã™è©±</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(//fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body {
        font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace;
      }
      ul li ul li {
        font-size: 75%;
      }
      p {
        font-size: 150%;
      }
      li {
        font-size: 30px;
      }
      .remark-slide-content h1 {
        font-size: 70px;
      }
      .remark-slide-content h2 {
        font-size: 50px;
      }
      h1, h2, h3 {
        font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        font-weight: normal;
        text-align: center;
      }
      img {
        max-width : 100%;
        max-height : 70%;
        display: block;
        margin-left: auto;
        margin-right: auto;
        border: 1px gray solid;
      }
      .remark-code, .remark-inline-code {
        font-size: 20px;
        font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace;
      }
      /* Two-column layout */
      .left-column {
        width: 50%;
        float: left;
      }
      .right-column {
        width: 45%;
        float: right;
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# publishã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç‹¬è‡ªã«ä½œã£ã¦ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¹ã‚’ç„¡ãã™è©±

[2017/07/06 Kafka Meetup #3](https://kafka-apache-jp.connpass.com/event/58619)

![CC-BY-NC-SA](https://licensebuttons.net/l/by-nc-sa/3.0/88x31.png)

---
class: middle

<img src="xuwei.gif" alt="icon" width="100" height="100" />

- twitter [@xuwei_k](https://twitter.com/xuwei_k)
- github [@xuwei-k](https://github.com/xuwei-k)
- blog <http://xuwei-k.hatenablog.com>

---
class: middle, center

å…ˆæœˆ(2017å¹´6æœˆ)

## Kafka 0.11 ãƒªãƒªãƒ¼ã‚¹ğŸ‰

---
class: middle, center

## Exactly Once !?

[Exactly-once Semantics are Possible: Hereâ€™s How Kafka Does it](https://www.confluent.io/blog/exactly-once-semantics-are-possible-heres-how-apache-kafka-does-it/)

---
class: middle, center

ã²ãŸã™ã‚‰<br/>

<span style="font-size: 150%;">At Least Once</span><br/>

ã‚’æ­»å®ˆã™ã‚‹ãŸã‚ã«ã‚„ã£ãŸã“ã¨ã®è©±ã‚’ã—ã¾ã™ãƒ»ãƒ»ãƒ»

---
class: middle, center

### 1å¹´åŠå‰

<span style="font-size: 50%;"><http://xuwei-k.github.io/slides/kafka-matsuri></span>

<iframe src="http://xuwei-k.github.io/slides/kafka-matsuri/#1" height="50%;" width="50%;">

---
class: middle, center

### 1å¹´ã¡ã‚‡ã£ã¨å‰

<iframe src="http://www.slideshare.net/slideshow/embed_code/key/GSQqdBuGyGlRaa?startSlide=33" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe> <div style="margin-bottom:5px"><a href="http://www.slideshare.net/matsu_chara/kafka-part2" title="Kafkaã‚’ä½¿ã£ãŸ ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹åŸºç›¤ part2 ï¼‹é‹ç”¨ã—ã¦èµ·ããŸãƒˆãƒ©ãƒ–ãƒ«é›†" target="_blank">Kafkaã‚’ä½¿ã£ãŸ ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹åŸºç›¤ part2 ï¼‹é‹ç”¨ã—ã¦èµ·ããŸãƒˆãƒ©ãƒ–ãƒ«é›†</a></div>

---
class: middle

### ã‚¹ãƒ©ã‚¤ãƒ‰ä¸€æšã§èª¬æ˜

- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ–ã¨ã—ã¦kafkaä½¿ã£ã¦ã„ã‚‹
- Java/Scala ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’httpãªã©ã§éš è”½ã—ã¦ç¤¾å†…ä»–ãƒãƒ¼ãƒ ã«æä¾›(ç›´æ¥kafkaè§¦ã‚‰ã›ãªã„)
- RAIDã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¨ãƒ©ãƒ¼äº‹ä»¶(**ä¸­é€”åŠç«¯ãª**æ­»ã«æ–¹ã—ã¦ã€publishå¤±æ•—ã™ã‚‹)
- brokerã®versionã‚¢ãƒƒãƒ—æ™‚ã«ã‚‚publishå¾®å¦™ã«å¤±æ•—ã™ã‚‹

---
class: middle

### æ€ã„ã¤ã„ãŸ and/or ææ¡ˆã—ã¦ã‚‚ã‚‰ã£ãŸå¯¾ç­–

- RAID ã‚„ã‚ã‚‹
- 1ã¤ã®Topicã‚ãŸã‚ŠPartitionã‚’2ã¤ä»¥ä¸Šä½œã£ã¦ç‹¬è‡ªã«é ‘å¼µã‚‹<br/><span style="font-size: 50%;">(ã‚ã‚‹æ„å‘³ãã†ã„ã†ã“ã¨ã—ã¦ã‚‹ã€ã¨ã„ã†ã®ã‚’ä»¥å‰ã®kafka meetupã§èã„ãŸæ°—ãŒã™ã‚‹)</span>

---
class: middle, center

## "Partition 2ã¤ä»¥ä¸Šä½œã£ã¦ç‹¬è‡ªã«é ‘å¼µã‚‹" æ¡ˆã§å‹åˆ©

<img src="win.gif" height="160%;" width-"160%;">

---
class: middle


![æ­£å¸¸æ™‚](kafka-01.png)

---
class: middle

![ç•°å¸¸æ™‚](kafka-02.png)

---
class: middle, center

åŸºæœ¬çš„ãªè€ƒãˆæ–¹

## partitionã‚’å†—é•·åº¦ã‚’ä¸Šã’ã‚‹ãŸã‚(ã ã‘)ã«ä½¿ã†

---
class: middle

## ã‚„ã£ãŸã“ã¨

1. borkerã‚’å¿…ãš6å°ä»¥ä¸Šç”¨æ„
2. 1ã¤ã®topicã«ã¤ãå¿…ãš2ã¤ä»¥ä¸Špartitionã‚’ç”¨æ„
3. topic/paritionç”Ÿæˆæ™‚ã®å‰²åˆã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’è‡ªä½œ
4. publishéƒ¨åˆ†ã‚’ç‹¬è‡ªã«ä½œã‚‹

---
class: middle, center

borkerã‚’å¿…ãš6å°ä»¥ä¸Šç”¨æ„

## replica 3 âœ• partition 2<br/>= 6å°å¿…è¦


---
class: middle, center

## 1ã¤ã®topicã«ã¤ãå¿…ãš2ã¤ä»¥ä¸Špartitionã‚’ç”¨æ„

1ã¤ã®partitionã§ã¯ã€èª¿å­æ‚ªããªã£ãŸã¨ãã®æ¬ æã‚„é…å»¶ã‚’é˜²ã’ãªã‹ã£ãŸã®ã§ã€2ã¤ç”¨æ„

---
class: middle, center

## kafkaã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‰²å½“ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚¤ã‚±ã¦ãªã„ !

ã“ã‚Œã‚’ã‚„ã‚Šå§‹ã‚ãŸã®ã¯0.9ç³»ã ãŒ<br/>0.11.0.0ã§ã‚‚å¤‰ã‚ã£ã¦ãªã•ãã†

<span style="font-size: 50%;">
<https://github.com/apache/kafka/blob/0.11.0.0/core/src/main/scala/kafka/admin/AdminUtils.scala#L137>
<span>

---
class: middle

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰(Scala)ã§ç¢ºã‹ã‚ã‚‰ã‚Œã‚‹

<pre>
<code class="scala hljs remark-code" style="font-size: 80%;">scalaVersion := "2.12.2"

libraryDependencies += "org.apache.kafka" %% "kafka" % "0.11.0.0"
</code>
</pre>

<pre>
<code class="scala hljs remark-code" style="font-size: 90%;">import kafka.admin._

List.fill(100000)(
  AdminUtils.assignReplicasToBrokers(
    brokerMetadatas = List(
      100, 200, 300, 400, 500, 600 // é©å½“ãªborkerå
    ).map(kafka.admin.BrokerMetadata(_, None)),
    nPartitions = 2,
    replicationFactor = 3
  )
).distinct.map(
  _.values.foldLeft(List[Int]())(_ ++ _).toSet.toList.sorted
).foreach(println)
</code>
</pre>

---
class: middle

4å°ã‹5å°ã«ã—ã‹åˆ†æ•£ã—ãªã„
<span style="font-size: 50%;">(brokerãŒ6å°ã‚ˆã‚Šå¤šãã¦ã‚‚åˆ†æ•£ã—ãªã„!?)</span>

<pre>
<code class="scala hljs remark-code" style="font-size: 70%;">
List(100, 200, 300, 400)
List(100, 400, 500, 600)
List(200, 300, 400, 500, 600)
List(100, 200, 500, 600)
List(100, 200, 400, 500, 600)
List(100, 200, 300, 600)
List(300, 400, 500, 600)
List(100, 200, 300, 400, 600)
List(100, 200, 300, 400, 600)
List(100, 200, 500, 600)
List(100, 200, 400, 500, 600)
List(300, 400, 500, 600)
List(100, 200, 300, 400, 500)
List(100, 200, 300, 400, 500)
List(100, 400, 500, 600)
List(200, 300, 400, 500, 600)
List(100, 300, 400, 500, 600)
List(100, 400, 500, 600)
List(100, 200, 300, 400)
List(200, 300, 400, 500)
List(200, 300, 400, 500)
List(100, 200, 300, 500, 600)
List(100, 200, 300, 500, 600)
List(100, 200, 300, 600)
List(100, 300, 400, 500, 600)
List(100, 200, 300, 600)
List(100, 200, 500, 600)
List(300, 400, 500, 600)
List(100, 200, 300, 400)
List(200, 300, 400, 500)
</code>
</pre>

---
class: middle

![å‰²å½“ãŒã‚¤ã‚±ã¦ãªã„](kafka-03.png)

---
class: middle

- topicåã®hashå€¤ä½¿ã£ã¦ã€ãƒ©ãƒ³ãƒ€ãƒ ã«ã¯ãªã‚‰ãªã„ã‚ˆã†ã«ã—ã¤ã¤ã€ã„ã„æ„Ÿã˜ã«åˆ†æ•£ã•ã‚Œã‚‹ã‚ˆã†ã«é ‘å¼µã£ãŸ
- [scalacheck](http://scalacheck.org/)ã¨ã„ã†property based testingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ãƒ†ã‚¹ãƒˆæ›¸ã„ã¦é‡ç‚¹çš„ã«ãƒã‚§ãƒƒã‚¯ã—ãŸ

---
class: middle

### å…·ä½“çš„ãªå®Ÿè£…ã®è©±

- [AdminUtils.addPartitions](https://github.com/apache/kafka/blob/0.11.0.0/core/src/main/scala/kafka/admin/AdminUtils.scala#L276) ã‚’ä½¿ã‚ãªã„<br/><span style="font-size: 60%;">(å¿…è¦ãªéƒ¨åˆ†ã ã‘æ®‹ã—ã¤ã¤æ”¹é€ )</span>
- ç‹¬è‡ªã«å‰²å½“ã‚’ä½œã£ãŸå¾Œã« AdminUtils ã®<br/><span style="font-size: 80%;">[createOrUpdateTopicPartitionAssignmentPathInZK](https://github.com/apache/kafka/blob/0.11.0.0/core/src/main/scala/kafka/admin/AdminUtils.scala#L483)</span><br/>ã‚’å‘¼ã¶


---
class: middle

## ç‹¬è‡ªã®publishãƒ­ã‚¸ãƒƒã‚¯

2ã¤ã®partitionã«å¯¾ã—ã¦

- æ™®æ®µã¯ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³
- ç‰‡æ–¹ãŒèª¿å­æ‚ªã„ã¨åˆ¤æ–­ã—ãŸã‚‰èª¿å­è‰¯ã„partitionã ã‘ã«é€ã‚‹
- å›å¾©ã—ãŸã‹ï¼Ÿã‚’åˆ¤æ–­ã—ã¦ã€è‰¯ãã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ã«æˆ»ã™
- å…¨éƒ¨èª¿å­æ‚ªãã†ã ã£ãŸã‚‰ã€(èª¿å­è‰¯ã„partitionè¦‹ã¤ã‹ã‚‹ã¾ã§)é€†ã«ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³

---
class: middle

## å…¬å¼ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã¤ã‚‰ã„

- å…¬å¼clientã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã¯ã€(å ´åˆã«ã‚ˆã£ã¦ã¯)å¤±æ•—ã™ã‚‹ã¨ã‚ã‹ã£ã¦ã„ã‚‹ã¨ã“ã‚ã«ä½•åº¦ã‚‚å†é€ã—ã¦ã—ã¾ã£ã¦æ„å‘³ãŒãªã„!?ã®ã§ã€ä½¿ã‚ãªã„!!!
- ãƒªãƒ¼ãƒ€ãƒ¼ãŒå­˜åœ¨ã—ã¦ã‚‹borkerãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‚¨ãƒ©ãƒ¼ãŒè¿”ã£ã¦ãã¦ã‚‹ã®ã«ã€ã¾ãŸãã“ã«publishã—ã‚ˆã†ã¨ã™ã‚‹ï¼Ÿï¼Ÿï¼Ÿãªã©
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚‚ã¡ã‚ƒã‚“ã¨è¨­å®šã—ãªã„ã¨ã€å±Šãå¯èƒ½æ€§ä½ã„ã®ã«ç„¡é§„ã«å¾…ã¤ã“ã¨ã«ãªã‚‹
- <span style="font-size: 50%;">(æœ€æ–°ç‰ˆã§æ”¹å–„ã•ã‚Œã¦ã„ã‚‹ã®ã‹ã©ã†ã‹ã¯æœªç¢ºèª)</span>


---
class: middle

- kafkaã«ã¯partitioné¸æŠãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ãŸã‚ã®å°‚ç”¨ã‚¯ãƒ©ã‚¹ãŒç”¨æ„ã•ã‚Œã¦ã‚‹
- <span style="font-size: 40%;"><https://github.com/apache/kafka/blob/0.11.0.0/clients/src/main/java/org/apache/kafka/clients/producer/Partitioner.java></span>
- ã—ã‹ã—<br/><span style="font-size: 140%;">ä½¿ã‚ãªã‹ã£ãŸ/ä½¿ãˆãªã‹ã£ãŸ</span>

---
class: middle, center

çµè«–ã¨ã—ã¦ã¯ã€partitionerä½¿ã†ã¨

## å¤±æ•—ã—ãŸpartitionã®<br/>çŠ¶æ…‹ç®¡ç†ãŒå³ã—ã„

---
class: middle

ã‚‚ã—partitionerä½¿ã„ã¤ã¤ã€çŠ¶æ…‹ç®¡ç†ã™ã‚‹ãªã‚‰?

- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°çµŒç”±ã§ã‚„ã‚Šã¨ã‚Šï¼Ÿ<br/><span style="font-size: 60%;">ãƒ†ã‚¹ãƒˆã‚„ã‚Šã¥ã‚‰ããªã‚‹ã€è¾›ã„</span>
- ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³çµŒç”±ã§ç„¡ç†ã‚„ã‚Šã©ã†ã«ã‹ã™ã‚‹ï¼Ÿ<br/><span style="font-size: 60%;">ãã‚Œã•ãˆå‡ºæ¥ã‚‹ã®ã‹ä¸æ˜ã€å‡ºæ¥ãŸã¨ã—ã¦ã‚‚è¾›ã„ã®ã§ã‚„ã‚ŠãŸããªã„</span>

---
class: middle

- producerã®å¤–ã§ç‹¬è‡ªã«çŠ¶æ…‹ç®¡ç†ã—ã¦ã€æŒ‡å®šã™ã‚‹å ´åˆã¯sendãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã§partitionã‚’æ˜ç¤º
- <span style="font-size: 40%;"><https://github.com/apache/kafka/blob/0.11.0.0/clients/src/main/java/org/apache/kafka/clients/producer/Producer.java#L76></span>


---
class: middle

- æƒ³å®šé€šã‚Šã€ã“ã‚Œã«ã‚ˆã£ã¦(2å°ä»¥ä¸ŠåŒæ™‚ã«æ­»ãªãªã„é™ã‚Š)publishå¤±æ•—ãŒãªããªã£ãŸ
- brokerå´ã®versionä¸Šã’ã‚‹(brokerå†èµ·å‹•ã™ã‚‹)ã¨ãã‚‚ã€ã“ã‚ŒãŒãªã„ã¨publishå¾®å¦™ã«å¤±æ•—ã™ã‚‹ã¨æ€ã†ã®ã§ã™ãŒã€ã¿ãªã•ã‚“ã©ã†ã—ã¦ã‚‹ã®ã‹ï¼Ÿ
- replicaã‚„ackã®è¨­å®šãŒé•ã†ï¼Ÿ

---
class: middle, center

## ãŠã‚ã‚Š

è³ªå•ã‚¿ã‚¤ãƒ ãªã©

    </textarea>
    <script src="//gnab.github.io/remark/downloads/remark-0.14.0.min.js" type="text/javascript"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript">
      var slideshow = remark.create({
        highlightStyle: "railscasts"
      });
      slideshow.on('beforeShowSlide', function (slide) {
        $("a[href^='http://']").attr("target", "_blank");
        $("a[href^='https://']").attr("target", "_blank");
      });
    </script>
  </body>
</html>
